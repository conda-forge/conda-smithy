# This file was automatically generated by conda-smithy. To update a component of this
# file, make changes to conda-forge.yml and/or recipe/meta.yaml, and run
# "conda smithy rerender".
# -*- mode: yaml -*-

{% if appveyor.image -%}
image: {{ appveyor.image }}
{% endif -%}

environment:

  {% for name, hashed_secure in (appveyor.secure or {}) | dictsort -%}
  {{ name }}:
    # The {{ name }} secure variable. This is defined canonically in conda-forge.yml.
    secure: {{ hashed_secure }}
  {%- endfor %}

  matrix:
  {%- for data in configs %}
    - CONFIG: {{ data.config_name}}
  {%- if "win-32" in data.platform %}
      CONDA_INSTALL_LOCN: C:\Miniconda36
{% else %}
      CONDA_INSTALL_LOCN: C:\Miniconda36-x64
{% endif -%}
{% endfor %}

# We always use a 64-bit machine, but can build x86 distributions
# with the TARGET_ARCH variable.
platform:
    - x64

install:
    - cmd: set "CI=appveyor"
    # If there is a newer build queued for the same PR, cancel this one.
    - cmd: |
        {{ fast_finish }}

    # Cygwin's git breaks conda-build. (See https://github.com/conda-forge/conda-smithy-feedstock/pull/2.)
    - cmd: rmdir C:\cygwin /s /q

    # Add path, activate `conda` and update conda.
    - cmd: call %CONDA_INSTALL_LOCN%\Scripts\activate.bat
    - cmd: conda.exe update --yes --quiet conda

    - cmd: set PYTHONUNBUFFERED=1

    # Configure the VM.
    # Tell conda we want an updated version of {%- if not local_ci_setup %} conda-forge-ci-setup=3 and{% endif %} conda-build
    - cmd: conda.exe install -n root -c conda-forge --quiet --yes {%- if not local_ci_setup %} conda-forge-ci-setup=3{% endif %} conda-build
    {%- if local_ci_setup %}
    - cmd: pip install --no-deps .\{{ recipe_dir }}\.
    {%- endif %}
    - cmd: setup_conda_rc .\ .\{{ recipe_dir }} .\.ci_support\%CONFIG%.yaml
    {% if build_setup -%}
    {{ build_setup }}{%- endif %}

# Skip .NET project specific build phase.
build: off

test_script:
    - cmd: conda.exe build {{ recipe_dir }} -m .ci_support\%CONFIG%.yaml
{%- if conda_forge_output_validation %}
    - set "FEEDSTOCK_NAME=%APPVEYOR_REPO_NAME:*/=%"
    - cmd: validate_recipe_outputs "%FEEDSTOCK_NAME%"
{%- endif %}
deploy_script:
    - set "GIT_BRANCH=%APPVEYOR_REPO_BRANCH%"
    - set "FEEDSTOCK_NAME=%APPVEYOR_REPO_NAME:*/=%"
{%- if upload_on_branch %}
    - set "UPLOAD_ON_BRANCH={{ upload_on_branch }}"
{%- endif %}
    - cmd: upload_package {% if conda_forge_output_validation %}--validate --feedstock-name="%FEEDSTOCK_NAME%"{% endif %}{% if private_upload %} --private{% endif %} .\ .\{{ recipe_dir }} .ci_support\%CONFIG%.yaml
