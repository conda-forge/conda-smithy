:: PLEASE NOTE: This script has been automatically generated by conda-smithy. Any changes here
:: will be lost next time ``conda smithy rerender`` is run. If you would like to make permanent
:: changes to this script, consider a proposal to conda-smithy so that other feedstocks can also
:: benefit from the improvement.

:: Note: we assume a Miniforge installation is available

:: INPUTS (required environment variables)
:: CONFIG: name of the .ci_support/*.yaml file for this job
:: CI: azure, github_actions, or unset
:: UPLOAD_PACKAGES: true or false
:: UPLOAD_ON_BRANCH: true or false

setlocal enableextensions enabledelayedexpansion

:: Activate the base conda environment
call activate base

:: Provision the necessary dependencies to build the recipe later
{%- if build_with_mambabuild %}
{%- set BOA="boa " %}
{%- else %}
{%- set BOA="" %}
{%- endif %}
echo Installing dependencies
mamba.exe install "python=3.10" conda-build conda pip {{ BOA }}{{ " ".join(remote_ci_setup) }} -c conda-forge --strict-channel-priority --yes
if errorlevel 1 exit 1

{%- if local_ci_setup %}
echo Overriding conda-forge-ci-setup with local version
conda.exe uninstall --quiet --yes --force {{ " ".join(remote_ci_setup) }}"
if errorlevel 1 exit 1
pip install --no-deps ".\{{ recipe_dir }}\."
if errorlevel 1 exit 1
{%- endif %}

:: Set basic configuration
echo Setting up configuration
setup_conda_rc .\ ".\{{ recipe_dir }}" .\.ci_support\%CONFIG%.yaml
if errorlevel 1 exit 1

{%- if build_setup %}
echo Running build setup
CALL {{ build_setup }}
if errorlevel 1 exit 1
{%- endif %}

if EXIST LICENSE.txt (
    echo Copying feedstock license
    copy LICENSE.txt "{{ recipe_dir }}\\recipe-scripts-license.txt"
)

{%- if test in ["native", "native_and_emulated"] %}
if NOT [%HOST_PLATFORM%] == [%BUILD_PLATFORM%] (
    set "EXTRA_CB_OPTIONS=%EXTRA_CB_OPTIONS% --no-test"
)
{%- endif %}

:: Build the recipe
echo Building recipe
{%- if build_with_mambabuild %}
conda.exe mambabuild "{{ recipe_dir }}" -m .ci_support\%CONFIG%.yaml --suppress-variables %EXTRA_CB_OPTIONS%
{%- else %}
conda.exe build "{{ recipe_dir }}" -m .ci_support\%CONFIG%.yaml --suppress-variables %EXTRA_CB_OPTIONS%
{%- endif %}
if errorlevel 1 exit 1

:: Prepare some environment variables for the upload step
if /i "%CI%" == "github_actions" (
    set "FEEDSTOCK_NAME=%GITHUB_REPOSITORY:*/=%"
    set "GIT_BRANCH=%GITHUB_REF:refs/heads/=%"
    if /i "%GITHUB_EVENT_NAME%" == "pull_request" (
        set "IS_PR_BUILD=True"
    ) else (
        set "IS_PR_BUILD=False"
    )
    set "TEMP=%RUNNER_TEMP%"
)
if /i "%CI%" == "azure" (
    set "FEEDSTOCK_NAME=%BUILD_REPOSITORY_NAME%"
    set "GIT_BRANCH=%BUILD_SOURCEBRANCHNAME%"
    if /i "%BUILD_REASON%" == "PullRequest" (
        set "IS_PR_BUILD=True"
    ) else (
        set "IS_PR_BUILD=False"
    )
    set "TEMP=$(UPLOAD_TEMP)"
)
{%- if upload_on_branch %}
set "UPLOAD_ON_BRANCH={{ upload_on_branch }}"
:: Note, this needs GIT_BRANCH too
{%- endif %}

:: Validate
{%- if conda_forge_output_validation %}
echo Validating recipe outputs
validate_recipe_outputs "%FEEDSTOCK_NAME%"
if errorlevel 1 exit 1
{%- endif %}

if /i "%UPLOAD_PACKAGES%" == "true" (
    if /i "%IS_PR_BUILD%" == "false" (
        if not exist "%TEMP%\" md "%TEMP%"
        set "TMP=%TEMP%"
        echo Uploading packages
        upload_package {% if conda_forge_output_validation %}--validate --feedstock-name="%FEEDSTOCK_NAME%"{% endif %}{% if private_upload %} --private{% endif %} .\ ".\{{ recipe_dir }}" .ci_support\%CONFIG%.yaml
        if errorlevel 1 exit 1
    )
)
